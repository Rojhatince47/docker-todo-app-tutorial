# --- DEPLOYMENT (Veritabanı Pod'unu Tanımlar) ---
apiVersion: apps/v1
kind: Deployment
metadata:
  # Deployment'ın adı. "kubectl get deployment" listesinde bu isim görünür.
  name: database-deployment
  labels:
    app: database
spec:
  # Bu Deployment'tan kaç adet pod oluşturulacağı.
  # Bir veritabanı için bu her zaman 1 olmalıdır.
  replicas: 1
  selector:
    # Bu Deployment'ın hangi pod'ları yönetmesi gerektiğini belirten etiket.
    # Aşağıdaki 'template.metadata.labels' ile eşleşmelidir.
    matchLabels:
      app: database
  template:
    metadata:
      # Pod'un etiketi. Service'in pod'u bulması için bu etiket kullanılır.
      labels:
        app: database
    spec:
      containers:
        # Container'ın adı
        - name: database-container
          # Kullanılacak Docker imajı (Sizin Docker Hub'a yüklediğiniz)
          image: rojhatince47/basic-docker-tutorial-db:proje
          resources:
            # Pod'un ne kadar kaynak (CPU/Memory) kullanabileceği.
            # "сри" değil "cpu" olmalı. "1000m" = 1 CPU çekirdeği.
            # "512M1" değil "512Mi" (Mebibyte) veya "512M" olmalı.
            limits:
              memory: "512Mi"
              cpu: "1000m"
          ports:
            # Container'ın dinlediği port
            - containerPort: 3306
# --- DÜZELTİLMİŞ 'env' BLOĞU ---
        # envFrom: bloğunu sildik, yerine bunu ekledik.
          env:
            # Bu değişkenleri 'dbsecret' içinden çekiyoruz
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: dbsecret
                  key: DB_NAME # dbsecret'teki 'DB_NAME' anahtarını kullan
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: dbsecret
                  key: DB_USERNAME # dbsecret'teki 'DB_USERNAME' anahtarını kullan
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dbsecret
                  key: DB_PASSWORD # dbsecret'teki 'DB_PASSWORD' anahtarını kullan
            
            # --- EKSİK DEĞİŞKEN ---
            # MySQL'in başlaması için BU DEĞİŞKEN ŞARTTIR.
            # Secret'ta olmadığı için manuel ekliyoruz.
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dbsecret
                  key: DB_PASSWORD # Root şifresi de normal şifreyle aynı olsun
                  
          # --- KALICI DEPOLAMA (Aktifleştirildi) ---
          # Bu pod'un içindeki /var/lib/mysql klasörünü
          # 'mysql-storage' adlı volume'a bağla.
          volumeMounts:
            - name: mysql-storage
              mountPath: /var/lib/mysql 
              
      # --- KALICI DEPOLAMA (Aktifleştirildi) ---
      # 'mysql-storage' adının ne olduğunu tanımla:
      volumes:
        - name: mysql-storage
          # Bu, yukarıda oluşturduğumuz PVC'nin (fişin) adıdır.
          persistentVolumeClaim:
            claimName: mysql-pvc
---

# --- SERVICE (Veritabanına Küme İçinde İsim Verir) ---
apiVersion: v1
kind: Service
metadata:
  # Service'in adı. Backend uygulaması bu isim üzerinden veritabanına bağlanacak.
  # Yani backend'in "host" adresi "database-service" olacak.
  name: database
spec:
  type: ClusterIP
  selector:
    # Hangi pod'lara trafik yönlendireceğini seçer.
    # Yukarıdaki Deployment'ın 'template.metadata.labels' etiketiyle eşleşmeli.
    app: database
  ports:
    - port: 3306
      targetPort: 3306
  # 'type' belirtilmediği için varsayılan 'ClusterIP' olacaktır.
  # Bu, servisin sadece küme (cluster) içinden erişilebilir olmasını sağlar.
  # Veritabanı için bu, doğru ve güvenli bir yöntemdir.
---
# --- 1. TALEP (PVC - Fiş) ---
# Önce kalıcı depolama talebini (fişini) oluşturuyoruz.
# Minikube'un 'StorageClass'ı bu talebi görünce
# otomatik olarak bir PV (askı) yaratacak.
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  # PVC'ye (fişe) bir isim veriyoruz
  name: mysql-pvc
spec:
  # Erişim Modu: ReadWriteOnce (RWO)
  # Diskin aynı anda SADECE TEK BİR pod'a bağlanabilmesini sağlar.
  # Veritabanları için bu zorunludur.
  accessModes:
    - ReadWriteOnce
  
  # Minikube'un varsayılan 'StorageClass' (vestiyer görevlisi) adını
  # buraya yazmak iyi bir pratiktir, ancak genelde 'standard' varsayılandır.
  # storageClassName: standard
  
  # Ne kadar alana ihtiyacımız var?
  resources:
    requests:
      storage: 5Gi # <Size> yerine 5 Gigabyte olarak düzeltildi